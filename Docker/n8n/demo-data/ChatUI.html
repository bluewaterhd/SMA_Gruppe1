<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAG Chat • Gruppe 1</title>
  <style>
    :root{
      --slate-950:#020617;
      --slate-900:#0f172a;
      --slate-800:#1e293b;
      --slate-500:#64748b;

      --violet:#8b5cf6;
      --purple:#a855f7;
      --fuchsia:#d946ef;
      --blue:#3b82f6;
      --cyan:#06b6d4;

      --border: rgba(255,255,255,.10);
      --card: rgba(15, 23, 42, .40);
      --glass: rgba(2, 6, 23, .50);
      --text: #e2e8f0;

      --shadowV: rgba(139,92,246,.45);
      --shadowB: rgba(59,130,246,.35);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: linear-gradient(135deg, var(--slate-900), var(--slate-800), var(--slate-900));
    }

    .container{width:100%; max-width:1024px; margin:0 auto; padding:0 16px;}
    .max-w-5xl{max-width:1024px;}
    main{min-height:100vh; display:flex; flex-direction:column;}

    header{
      position:sticky; top:0; z-index:10;
      border-bottom:1px solid var(--border);
      background: rgba(2, 6, 23, .50);
      backdrop-filter: blur(16px);
    }
    .header-inner{display:flex; align-items:center; gap:16px; padding:24px 0;}
    .logo{
      position:relative;
      width:48px; height:48px;
      border-radius:16px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--violet), var(--purple), var(--fuchsia));
      box-shadow: 0 18px 36px -18px var(--shadowV);
      flex:0 0 auto;
    }
    .sparkles{
      position:absolute; top:-6px; right:-6px;
      width:14px; height:14px;
      color:#fcd34d;
      animation: pulse 1.4s ease-in-out infinite;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.45));
    }
    h1{margin:0; font-size:24px; font-weight:800; color:white;}
    .subtitle{margin:4px 0 0; font-size:14px; font-weight:600; color: rgba(196,181,253,.95);}

    .wrap{flex:1; padding:32px 0;}
    .card{
      height: calc(100vh - 180px);
      min-height: 520px;
      display:flex;
      flex-direction:column;
      border:1px solid var(--border);
      border-radius: 22px;
      background: var(--card);
      backdrop-filter: blur(16px);
      box-shadow: 0 28px 80px -44px rgba(0,0,0,.78);
      overflow:hidden;
    }

    .messages{
      flex:1;
      overflow:auto;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:24px;
      scroll-behavior:smooth;
    }
    .row{display:flex; gap:16px; align-items:flex-start; animation:in .38s ease-out both;}
    .row.reverse{flex-direction:row-reverse;}
    .msg-avatar{
      width:40px; height:40px;
      border-radius:16px;
      display:grid; place-items:center;
      box-shadow: 0 18px 36px -24px rgba(0,0,0,.8);
      flex:0 0 auto;
      color:white;
    }
    .msg-avatar.user{
      background: linear-gradient(135deg, var(--blue), var(--cyan));
      box-shadow: 0 18px 36px -24px var(--shadowB);
    }
    .msg-avatar.bot{
      background: linear-gradient(135deg, var(--violet), var(--purple), var(--fuchsia));
      box-shadow: 0 18px 36px -24px var(--shadowV);
    }
    .bubble-col{display:flex; flex-direction:column; max-width:75%;}
    .row.reverse .bubble-col{align-items:flex-end;}
    .bubble{
      border-radius: 18px;
      padding: 12px 16px;
      line-height: 1.45;
      font-size: 14px;
      word-break: break-word;
      white-space: pre-wrap;
      box-shadow: 0 18px 40px -30px rgba(0,0,0,.85);
    }
    .bubble.user{
      color: white;
      background: linear-gradient(135deg, var(--blue), var(--cyan));
      box-shadow: 0 18px 40px -30px var(--shadowB);
    }
    .bubble.bot{
      color: var(--text);
      background: rgba(30,41,59,.80);
      border: 1px solid var(--border);
    }
    /* Make the typing indicator bubble only as big as the three dots */
    .bubble.bot.loading{
      display: inline-flex;
      width: fit-content;
      padding: 10px 12px;
      border-radius: 16px;
      align-items: center;
      justify-content: center;
    }
    .bubble-col.loading{
      max-width: none;
      align-items: flex-start;
    }
    .time{
      margin-top:8px;
      font-size:12px;
      color: rgba(148,163,184,.65);
      padding: 0 8px;
    }

    .inputbar{
      border-top:1px solid var(--border);
      background: rgba(2, 6, 23, .50);
      backdrop-filter: blur(16px);
      padding: 24px;
    }
    .controls{display:flex; gap:12px; align-items:center;}
    input[type="text"]{
      flex:1;
      height:48px;
      padding:0 14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(30,41,59,.50);
      color: white;
      outline:none;
      font-size:14px;
    }
    input[type="text"]::placeholder{color: rgba(148,163,184,.75);}
    input[type="text"]:focus{
      border-color: rgba(139,92,246,.85);
      box-shadow: 0 0 0 4px rgba(139,92,246,.18);
    }
    button{
      width:48px; height:48px;
      border:0;
      border-radius: 14px;
      cursor:pointer;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--violet), var(--purple), var(--fuchsia));
      box-shadow: 0 18px 36px -20px var(--shadowV);
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
      color: white;
    }
    button:hover{transform: scale(1.05); filter: brightness(1.05);}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none; filter:none;}

    .typing{display:flex; gap:6px; align-items:center;}
    .typing .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(167,139,250,.95);
      animation: bounce 0.9s ease-in-out infinite;
    }
    .typing .dot:nth-child(2){animation-delay:.2s; background: rgba(192,132,252,.95);}
    .typing .dot:nth-child(3){animation-delay:.4s; background: rgba(244,114,182,.95);}

    .icon{width:20px; height:20px; fill:none; stroke:currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round;}
    .icon-lg{width:28px; height:28px;}
    .icon-sm{width:14px; height:14px;}

    @keyframes pulse{0%,100%{transform:scale(1); opacity:1}50%{transform:scale(1.08); opacity:.75}}
    @keyframes bounce{0%,100%{transform:translateY(0); opacity:.85}50%{transform:translateY(-5px); opacity:1}}
    @keyframes in{from{transform:translateY(12px); opacity:0}to{transform:translateY(0); opacity:1}}

    .messages::-webkit-scrollbar{width:10px}
    .messages::-webkit-scrollbar-thumb{background:rgba(148,163,184,.25); border-radius:999px; border:2px solid rgba(2,6,23,.25)}
    .messages::-webkit-scrollbar-track{background:rgba(2,6,23,.15)}

    @media (max-width: 640px){
      h1{font-size:20px}
      .bubble-col{max-width:86%}
      .card{height: calc(100vh - 170px);}
    }
  </style>
</head>
<body>
<main>
  <header>
    <div class="container">
      <div class="header-inner">
        <div class="logo" aria-hidden="true">
          <svg class="icon icon-lg" viewBox="0 0 24 24">
            <path d="M12 8V4"></path>
            <path d="M8 4h8"></path>
            <rect x="4" y="8" width="16" height="12" rx="4"></rect>
            <path d="M9 14h.01"></path>
            <path d="M15 14h.01"></path>
            <path d="M8 20v1"></path>
            <path d="M16 20v1"></path>
          </svg>
          <svg class="sparkles icon icon-sm" viewBox="0 0 24 24">
            <path d="M12 2l1.2 4.2L17.4 8 13.2 9.2 12 13.4 10.8 9.2 6.6 8l4.2-1.8L12 2z"></path>
            <path d="M19 13l.7 2.3L22 16l-2.3.7L19 19l-.7-2.3L16 16l2.3-.7L19 13z"></path>
          </svg>
        </div>
        <div>
          <h1>RAG Chat</h1>
          <div class="subtitle">Gruppe 1 • KI-Assistent</div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="container max-w-5xl">
      <div class="card" role="application" aria-label="Chat">
        <div id="messages" class="messages" aria-live="polite"></div>

        <div class="inputbar">
          <div class="controls">
            <input id="input" type="text" placeholder="Schreiben Sie Ihre Nachricht..." autocomplete="off" />
            <button id="sendBtn" type="button" aria-label="Senden">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M22 2L11 13"></path>
                <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
              </svg>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</main>

<script>
const WEBHOOK_URL = 'http://localhost:5678/webhook/rag-chat';

  const state = {
    messages: [
      { id: "1", role: "assistant", content: "Hallo! Willkommen beim RAG Chat von Gruppe 1. Wie kann ich Ihnen heute helfen?", timestamp: new Date() }
    ],
    isLoading: false
  };

  const $messages = document.getElementById("messages");
  const $input = document.getElementById("input");
  const $sendBtn = document.getElementById("sendBtn");

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, (c) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[c]));
  }

  function fmtTime(date) {
    try {
      return new Intl.DateTimeFormat("de-DE", { hour: "2-digit", minute: "2-digit" }).format(date);
    } catch {
      const h = String(date.getHours()).padStart(2,"0");
      const m = String(date.getMinutes()).padStart(2,"0");
      return h + ":" + m;
    }
  }

  function icon(role) {
    if (role === "user") {
      return `
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20 21a8 8 0 0 0-16 0"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>`;
    }
    return `
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 8V4"></path>
        <path d="M8 4h8"></path>
        <rect x="4" y="8" width="16" height="12" rx="4"></rect>
        <path d="M9 14h.01"></path>
        <path d="M15 14h.01"></path>
        <path d="M8 20v1"></path>
        <path d="M16 20v1"></path>
      </svg>`;
  }

  function updateControls() {
    const hasText = $input.value.trim().length > 0;
    $sendBtn.disabled = state.isLoading || !hasText;
    $input.disabled = state.isLoading;
  }

  function render() {
    const parts = [];

    for (const m of state.messages) {
      const isUser = m.role === "user";
      parts.push(`
        <div class="row ${isUser ? "reverse" : ""}">
          <div class="msg-avatar ${isUser ? "user" : "bot"}">${icon(m.role)}</div>
          <div class="bubble-col" style="${isUser ? "align-items:flex-end;" : "align-items:flex-start;"}">
            <div class="bubble ${isUser ? "user" : "bot"}">${escapeHtml(m.content)}</div>
            <div class="time">${fmtTime(m.timestamp)}</div>
          </div>
        </div>
      `);
    }

    if (state.isLoading) {
      parts.push(`
        <div class="row">
          <div class="msg-avatar bot">${icon("assistant")}</div>
          <div class="bubble-col loading">
            <div class="bubble bot loading">
              <div class="typing" aria-label="Antwort wird generiert">
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
              </div>
            </div>
          </div>
        </div>
      `);
    }

    $messages.innerHTML = parts.join("");
    $messages.scrollTop = $messages.scrollHeight;

    const hasText = $input.value.trim().length > 0;
    $sendBtn.disabled = state.isLoading || !hasText;
    $input.disabled = state.isLoading;
  }

  async function handleSend() {
    const text = $input.value.trim();
    if (!text || state.isLoading) return;

    state.messages.push({ id: String(Date.now()), role: "user", content: text, timestamp: new Date() });
    $input.value = "";
    state.isLoading = true;
    render();

    try {
      const response = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });

      if (!response.ok) throw new Error("Fehler bei der Anfrage");
      const data = await response.json();

      state.messages.push({
        id: String(Date.now() + 1),
        role: "assistant",
        content: data.text || data.output || data.response || "Entschuldigung, ich konnte keine Antwort generieren.",
        timestamp: new Date()
      });
    } catch (err) {
      console.error("Fehler beim Senden der Nachricht:", err);
      state.messages.push({
        id: String(Date.now() + 1),
        role: "assistant",
        content: "Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.",
        timestamp: new Date()
      });
    } finally {
      state.isLoading = false;
      render();
    }
  }

  $sendBtn.addEventListener("click", handleSend);
  $input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
  $input.addEventListener("input", updateControls);

  render();
  updateControls();
</script>
</body>
</html>
