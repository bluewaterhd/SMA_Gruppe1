{
  "name": "Ingestion",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        688,
        0
      ],
      "id": "0d5d6175-b293-411a-bbca-45f44d8c6d0a",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "efc2ce06-b6fb-4fbb-aa6c-edb138e415d5",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "fieldToSplitOut": "chunks",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        2544,
        192
      ],
      "id": "d5ec44d6-dbc9-49bc-9a5c-8ae672fb8da5",
      "name": "Split Out"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "50156f38-7281-4687-8d78-466cbb885feb",
              "name": "baseUrl",
              "value": "https://api.zotero.org",
              "type": "string"
            },
            {
              "id": "b78103d0-9f98-450c-b30e-90c0c951bdc2",
              "name": "apiKey",
              "value": "3VKaGKjrQY46wqTqF5Deuxmc",
              "type": "string"
            },
            {
              "id": "7d680a4b-6455-4940-bbd6-c25552944a32",
              "name": "doclingBaseUrl",
              "value": "http://docling:5001/v1",
              "type": "string"
            },
            {
              "id": "40ee2479-62cf-47ec-b436-b480e291adac",
              "name": "paperCount",
              "value": 1,
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        272,
        0
      ],
      "id": "2ac9e14d-7471-4bc3-b4b8-1aa50260773d",
      "name": "SetConstants"
    },
    {
      "parameters": {
        "url": "={{ $json.baseUrl }}/groups/6357600/items/top",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Zotero-API-Key",
              "value": "={{ $json.apiKey }}"
            },
            {
              "name": "Zotero-API-Version",
              "value": "3"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        480,
        0
      ],
      "id": "d0836ad3-33e7-4e57-b28c-7f1af40c7f84",
      "name": "GetZoteroItems"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6821e051-7a2c-42eb-9dff-004510241202",
              "leftValue": "={{ \n  ($json.data.itemType === \"attachment\" && \n   $json.data.contentType === \"application/pdf\") \n  || \n  $json.data.filename?.endsWith(\".pdf\")\n}}",
              "rightValue": "attachment",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        896,
        128
      ],
      "id": "99fe48e8-68db-46ad-bddd-c7c42cf091db",
      "name": "IsPDF?"
    },
    {
      "parameters": {
        "url": "={{ $('SetConstants').item.json.baseUrl }}/groups/6357600/items/{{$json.key}}/children",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=Authorization",
              "value": "=Bearer {{ $('SetConstants').item.json.apiKey }}"
            },
            {
              "name": "Zotero-API-Version",
              "value": "3"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1104,
        208
      ],
      "id": "6b8e4689-227b-433e-81d1-fc868f49d7a4",
      "name": "GetPDF"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6821e051-7a2c-42eb-9dff-004510241202",
              "leftValue": "={{ \n  ($json.data.itemType === \"attachment\" && \n   $json.data.contentType === \"application/pdf\") \n  || \n  $json.data.filename?.endsWith(\".pdf\")\n}}",
              "rightValue": "attachment",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1312,
        208
      ],
      "id": "94fccf70-3b23-4540-88b4-e0d4e1af9979",
      "name": "IsPDF"
    },
    {
      "parameters": {
        "url": "={{ $('SetConstants').item.json.baseUrl }}/groups/6357600/items/{{ $json.key }}/file",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('SetConstants').item.json.apiKey }}"
            },
            {
              "name": "Zotero-API-Version",
              "value": "3"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1600,
        192
      ],
      "id": "71fc4bd1-1626-4072-a07e-0046e4c09af9",
      "name": "DownloadPDF"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f65b926a-6ae8-49ad-94ec-91e0893404e5",
              "leftValue": "={{ $json.links.enclosure.length }}",
              "rightValue": 2000000,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1840,
        192
      ],
      "id": "b5733fa5-6b0d-44ec-adf9-9542bf8fb02d",
      "name": "IsBig?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('SetConstants').item.json.doclingBaseUrl }}/chunk/hybrid/file",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            },
            {
              "name": "chunking_max_tokens",
              "value": "800"
            },
            {
              "name": "chunking_merge_peers",
              "value": "true"
            },
            {
              "name": "chunking_tokenizer",
              "value": "sentence-transformers/all-MiniLM-L6-v2"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2256,
        224
      ],
      "id": "80d85f65-d4c0-4398-8cad-4a607804975f",
      "name": "GetChunks"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f8e5d9a0-0c30-4cd3-8bde-63562cb28e19",
              "name": "chunk_id",
              "value": "=paper{{ $('SetConstants').item.json.paperCount }}chunk{{ $json.chunk_index }}",
              "type": "string"
            },
            {
              "id": "14a5a2f0-3c5b-4836-a4c7-3be442fb591c",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "b887b862-dd1d-436d-9045-f34f8c20eb8e",
              "name": "doc_name",
              "value": "={{ $('GetZoteroItems').item.json.data.title }}",
              "type": "string"
            },
            {
              "id": "47bb2578-39f3-46ad-8be0-12a79a45757b",
              "name": "page_start",
              "value": "={{ $json.page_numbers[0] }}",
              "type": "number"
            },
            {
              "id": "a186699f-be2d-4fa4-93f9-5beaaeb35ad1",
              "name": "page_end",
              "value": "={{ $json.page_numbers.length }}",
              "type": "number"
            },
            {
              "id": "88b5f326-46cf-4ffc-8004-34325d4d0ec4",
              "name": "tag",
              "value": "ai",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3024,
        192
      ],
      "id": "040b57c5-30b2-49d6-886a-525765d9b740",
      "name": "FormatChunks"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "dokumente_log",
          "mode": "list",
          "cachedResultName": "dokumente_log"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "seitestart": "={{ $json.page_start }}",
            "seiteende": "={{ $json.page_end }}",
            "inhalt": "={{ $json.text }}",
            "titel": "={{ $json.doc_name }}",
            "tag": "={{ $json.tag }}",
            "chunkid": "{{ $json.chunk_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "chunkid",
              "displayName": "chunkid",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "titel",
              "displayName": "titel",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seitestart",
              "displayName": "seitestart",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "seiteende",
              "displayName": "seiteende",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "inhalt",
              "displayName": "inhalt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tag",
              "displayName": "tag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3536,
        192
      ],
      "id": "4c26a73a-104c-4b64-91ef-d31a3fa5f7f1",
      "name": "Chunks into postgre",
      "credentials": {
        "postgres": {
          "id": "EefzEhRlFWiyVSDE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('SetConstants').item.json.doclingBaseUrl }}/chunk/hybrid/file/async",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "files",
              "inputDataFieldName": "data"
            },
            {
              "name": "chunking_max_tokens",
              "value": "800"
            },
            {
              "name": "chunking_merge_peers",
              "value": "true"
            },
            {
              "name": "chunking_tokenizer",
              "value": "sentence-transformers/all-MiniLM-L6-v2"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2256,
        480
      ],
      "id": "d8ddc6e8-5c4b-4404-a133-f72e63bb4562",
      "name": "GetChunks1"
    },
    {
      "parameters": {
        "url": "={{ $('SetConstants').item.json.doclingBaseUrl }}/status/poll/{{$json.task_id}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2464,
        480
      ],
      "id": "49038e62-263f-4819-a772-a867e445c9d5",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "9293b214-2997-439c-8639-ce697c78e0da",
              "leftValue": "={{ [\"success\", \"done\", \"completed\"].includes($json.task_status) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2672,
        480
      ],
      "id": "1454bb72-8998-4deb-981d-70722537cbdd",
      "name": "If"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6bed4c9a-70c6-4c9c-9b85-c91db60dab91",
              "leftValue": "={{ [\"fail\", \"error\"].includes($json.task_status) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3280,
        656
      ],
      "id": "b2f9ed4c-7ace-4e85-a55c-74bb7f18b520",
      "name": "If1"
    },
    {
      "parameters": {
        "amount": 60
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3504,
        800
      ],
      "id": "16fabb9e-bece-46f2-87f3-429b9ae20ac2",
      "name": "Wait",
      "webhookId": "14bd6179-1cab-4754-97de-fa77f8c20a71"
    },
    {
      "parameters": {
        "batchSize": 3,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3808,
        192
      ],
      "id": "fa9baa67-78b3-4e53-b193-3db4500d46c4",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://ollama:11434/api/embeddings",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "nomic-embed-text"
            },
            {
              "name": "prompt",
              "value": "={{ $('Chunks into postgre').item.json.inhalt }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4016,
        368
      ],
      "id": "fc1823a9-ba81-46a0-b24e-a8bb8c37dc0c",
      "name": "Embeddings1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4592,
        528
      ],
      "id": "21c76aee-7e52-4c28-b006-4ed636bd89d7",
      "name": "Wait1",
      "webhookId": "828f9975-a3bd-4902-acef-1c87497b708c"
    },
    {
      "parameters": {
        "url": "={{ $('SetConstants').item.json.doclingBaseUrl }}/result/{{ $('HTTP Request1').item.json.task_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2992,
        448
      ],
      "id": "deaa4cf9-921d-406c-a888-4578651def49",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e075c2de-880d-493c-a4a8-e04fcbfeb8b9",
              "name": "paperCount",
              "value": "={{ $('SetConstants').item.json.paperCount +1 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4112,
        176
      ],
      "id": "3a7a725e-305b-444b-8d1a-349d84284d07",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "http://qdrant:6333/collections/chunks/points?wait=true",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n{\n  \"points\": [\n    {\n      \"id\": Number($('Chunks into postgre').item.json.id),\n      \"vector\": $json.embedding,\n      \"payload\": { \"chunkid\": $('FormatChunks').item.json.chunk_id, \"text\": $('FormatChunks').item.json.text }\n    }\n  ]\n}\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4352,
        432
      ],
      "id": "436e05f4-a5d6-443f-928b-ba7c5bb3c15b",
      "name": "HTTP Request3"
    }
  ],
  "pinData": {},
  "connections": {
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "IsPDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "SetConstants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "FormatChunks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SetConstants": {
      "main": [
        [
          {
            "node": "GetZoteroItems",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetZoteroItems": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IsPDF?": {
      "main": [
        [
          {
            "node": "DownloadPDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GetPDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetPDF": {
      "main": [
        [
          {
            "node": "IsPDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IsPDF": {
      "main": [
        [
          {
            "node": "DownloadPDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DownloadPDF": {
      "main": [
        [
          {
            "node": "IsBig?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IsBig?": {
      "main": [
        [
          {
            "node": "GetChunks1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GetChunks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetChunks": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FormatChunks": {
      "main": [
        [
          {
            "node": "Chunks into postgre",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chunks into postgre": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetChunks1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Embeddings1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings1": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "11f252aa-bfd2-453d-ac8d-176f7c920e14",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2e5c459191bca6972a6ed06a2c5d41835b85727e5281032a4ad737c853e399fa"
  },
  "id": "qZdWk0RNLypNhw9r",
  "tags": []
}